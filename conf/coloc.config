params {
    gwas_ss_tsv = "${baseDir}/testdata_coloc/gwas_sumstats_multi.tsv" 
    qtl_ss_tsv = "${baseDir}/testdata_coloc/eqtl_sumstats.tsv"
    gwas_lift_chain = "/gpfs/hpc/projects/eQTLCatalogue/GRCh37_to_GRCh38/GRCh37_to_GRCh38.chain.gz"
    hg38_ref_genome = "/gpfs/hpc/projects/genomic_references/annotations/hg38/hg38.fa"
    outdir = './results_coloc'
    gene_variant_list = "${baseDir}/testdata_coloc/lead_pairs_rnaseq.tsv"
    cis_window = 200000
    n_batches = 50
}

executor {
    name = 'slurm'
    queueSize = 400
    submitRateLimit = 1
}

process {
    executor = 'slurm'
    queue = 'main'
    beforeScript = 'module load singularity/3.5.3'

    cpus = { check_max( 2 * task.attempt, 'cpus' ) }
    memory = { check_max( 8.GB * task.attempt, 'memory' ) }
    time = { check_max( 4.h * task.attempt, 'time' ) }

    maxRetries = 3
    maxErrors = '-1'

    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'terminate' }
    // errorStrategy = 'retry' 

    withName: lift_to_GRCh38 {
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        cpus = 1
        time = { check_max( 4.h * task.attempt, 'time' ) }
    }
    withName: tabix_index_gwas {
        memory = { check_max( 8.GB * task.attempt, 'memory' ) }
        cpus = 1
        time = { check_max( 2.h * task.attempt, 'time' ) }
    }
    withName: run_coloc {
        memory = { check_max( 8.GB * task.attempt, 'memory' ) }
        cpus = 1
        time = { check_max( 1.h * task.attempt, 'time' ) }
    }
    withName: merge_coloc_results {
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        cpus = 1
        time = { check_max( 2.h * task.attempt, 'time' ) }
    }
}

singularity {
  enabled = true
  autoMounts = true
  cacheDir = "$baseDir/singularity_img/"
}